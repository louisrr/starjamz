version: '3.8'

services:
  gateway-service:
    build: ./GatewayService
    ports:
      - "8080:8080"
  payment-service:
    build: ./PaymentService
    ports:
      - "8081:8080"
  music-service:
    build: ./MusicService
    ports:
      - "8082:8080"
  admin-service:
    build: ./AdminService
    ports:
      - "8083:8080"
  user-service:
    build: ./UserService
    ports:
      - "8084:8080"      
  feed-service:
    build: ./FeedService
    ports:
      - "8085:8080"   
  like-service:
    build: ./LikeService
    ports:
      - "8086:8080"
  upload-service:
    build: ./UploadService
    ports:
      - "8087:8080"
    environment:
      - SPRING_DATA_CASSANDRA_CONTACT_POINTS=scylla
      - SPRING_DATA_CASSANDRA_KEYSPACE_NAME=starjamz_uploads
    depends_on:
      scylla-init:
        condition: service_completed_successfully

  # ── Frontend ──────────────────────────────────────────────────────────────────
  frontend:
    build: ./Frontend/starjamz
    ports:
      - "3000:3000"

  # ── ScyllaDB ─────────────────────────────────────────────────────────────────
  scylla:
    image: scylladb/scylla:5.4
    ports:
      - "9042:9042"   # CQL native transport
    volumes:
      - scylla_data:/var/lib/scylla
    # --smp 1 limits ScyllaDB to one CPU shard, --memory 512M caps RAM — both
    # suitable for local dev. Remove these flags in production.
    command: ["--smp", "1", "--memory", "512M", "--overprovisioned", "1"]
    healthcheck:
      test: ["CMD-SHELL", "cqlsh -e 'DESCRIBE CLUSTER' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 30s

  # One-shot container that waits for ScyllaDB then applies schema.cql
  scylla-init:
    image: scylladb/scylla:5.4
    depends_on:
      scylla:
        condition: service_healthy
    volumes:
      - ./scylla/schema.cql:/scylla/schema.cql:ro
      - ./scylla/init.sh:/scylla/init.sh:ro
    environment:
      - SCYLLA_HOST=scylla
      - SCYLLA_PORT=9042
      - SCHEMA_FILE=/scylla/schema.cql
    entrypoint: ["/bin/bash", "/scylla/init.sh"]
    restart: "no"

volumes:
  scylla_data: